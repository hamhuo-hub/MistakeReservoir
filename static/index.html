<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈîôÈ¢òÊú¨</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            color: #334155;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            font-weight: 300;
            color: #1e293b;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 16px;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        button:hover {
            opacity: 0.9;
        }

        .preview-list {
            margin-top: 20px;
        }

        .q-item {
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 0;
            display: flex;
            gap: 15px;
        }

        .q-meta {
            min-width: 80px;
            font-weight: bold;
            color: var(--primary);
        }

        .q-content {
            flex: 1;
        }

        .q-content img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 4px;
        }

        .material-badge {
            background: #fef3c7;
            color: #d97706;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        #stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            text-align: center;
            box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
        }

        .stat-num {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        /* Grid Styles */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .grid-item {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .grid-item:hover {
            border-color: var(--primary);
        }

        .grid-item.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .type-tag {
            display: block;
            font-size: 10px;
            margin-top: 2px;
            opacity: 0.6;
        }

        /* Optional type coloring */
        .t-changshi {
            border-bottom: 3px solid #fcd34d;
        }

        .t-yanyu {
            border-bottom: 3px solid #f87171;
        }

        .t-shuliang {
            border-bottom: 3px solid #60a5fa;
        }

        .t-ziliao {
            border-bottom: 3px solid #4ade80;
        }

        .t-panduan {
            border-bottom: 3px solid #c084fc;
        }

        .header-icon {
            width: 32px;
            height: 32px;
            vertical-align: middle;
            margin-right: 10px;
        }

        .btn-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 5px;
        }

        .theme-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        /* Stats Styles */
        .chart-container {
            margin-top: 10px;
            height: 200px;
            width: 100%;
            position: relative;
            background: whitesmoke;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            padding: 10px 20px;
            box-sizing: border-box;
        }

        .bar-chart-bar {
            flex: 1;
            margin: 0 2px;
            background: #93c5fd;
            transition: 0.2s;
            position: relative;
        }

        .bar-chart-bar:hover {
            background: #2563eb;
        }

        .bar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            display: none;
            z-index: 10;
        }

        .bar-chart-bar:hover .bar-tooltip {
            display: block;
        }

        /* Heatmap Styles - GitHub Style */
        .heatmap-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .heatmap-months {
            display: flex;
            margin-left: 30px;
            /* Offset for day labels */
            margin-bottom: 5px;
            font-size: 10px;
            color: #64748b;
        }

        .month-label {
            /* Width will be set dynamically or approx based on weeks */
        }

        .heatmap-body {
            display: flex;
        }

        .heatmap-days {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-right: 5px;
            font-size: 10px;
            color: #64748b;
            margin-top: 15px;
            /* Alignment adjustment */
            height: 75px;
            /* 7 rows * (10+3) roughly */
            line-height: 10px;
        }

        .day-label {
            height: 10px;
            /* Match square height */
            margin-bottom: 3px;
            /* Match grid gap */
        }

        .heatmap-grid {
            display: grid;
            grid-template-rows: repeat(7, 10px);
            grid-auto-flow: column;
            gap: 3px;
        }

        .day-square {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background: #e2e8f0;
            /* level 0 */
            position: relative;
        }

        .day-square:hover::after {
            content: attr(data-title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
        }

        .level-0 {
            background: #ebedf0;
        }

        .level-1 {
            background: #9be9a8;
        }

        .level-2 {
            background: #40c463;
        }

        .level-3 {
            background: #30a14e;
        }

        .level-4 {
            background: #216e39;
        }
    </style>
</head>

<body>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div id="stats-bar" style="flex:1; margin-bottom:0; margin-right:20px;">
                <!-- populated by js -->
            </div>
            <div>
                <a href="/browse" class="theme-btn" title="Browse Database"
                    style="display:inline-flex; width:auto; padding:0 15px; border-radius:20px; text-decoration:none; margin-right:10px; color:#334155; font-size:16px;">
                    üìÇ <span style="margin-left:5px; font-size:14px; font-weight:bold;">ÊµèËßàÈ¢òÂ∫ì</span>
                </a>
                <button id="themeToggleBtn" onclick="toggleTheme()" class="theme-btn" title="Switch Theme">üé®</button>
            </div>
        </div>

        <div class="card">
            <h2><img id="icon_upload" src="" class="header-icon"> ÈîôÈ¢òÂΩïÂÖ•</h2>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <span id="fileName">ÁÇπÂáªÈÄâÊã© DOCX Êñá‰ª∂</span>
                <input type="file" id="fileInput" hidden accept=".docx">
            </div>

            <!-- New Grid Selection Area -->
            <div id="gridPanel" style="display:none; margin-top: 20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <label>ËØ∑ÈÄâÊã©È¢òÁõÆ:</label>
                    <div style="display:flex; gap: 5px;">
                        <button onclick="selectAll()"
                            style="padding:5px 10px; margin:0; font-size:14px; background:#64748b;">ÂÖ®ÈÄâ</button>
                        <button onclick="clearSelection()"
                            style="padding:5px 10px; margin:0; font-size:14px; background:#ef4444;">Ê∏ÖÁ©∫</button>
                    </div>
                </div>

                <div id="qGrid" class="grid-container"></div>

                <div style="margin-top:15px; text-align:right;">
                    <span id="selectionSummary" style="margin-right:15px; font-weight:bold; color:var(--primary);">Â∑≤ÈÄâ: 0
                        È¢ò</span>
                    <button onclick="extractPreview()" id="extractBtn">
                        <img id="icon_preview" src="" class="btn-icon"> Ëß£ÊûêÈ¢ÑËßà
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><img id="icon_generate_header" src="" class="header-icon"> ÁîüÊàêÈîôÈ¢òÂç∑</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="number" id="genCount" value="130" style="width:80px; margin:0;" min="1" max="135">
                <label>È¢òÈáè</label>
                <button onclick="generatePaper()" style="margin:0;">
                    <img id="icon_generate_btn" src="" class="btn-icon"> ÁîüÊàêÈîôÈ¢òÂç∑
                </button>
            </div>
            <div id="downloadArea" style="margin-top:15px;"></div>
        </div>

        <div class="card" id="previewArea" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>È¢ÑËßà (<span id="previewCount">0</span> È¢ò)</h3>
                <button onclick="confirmSave()" style="background:#16a34a;">
                    <img id="icon_import" src="" class="btn-icon"> Á°ÆËÆ§ÂÖ•Â∫ì
                </button>
            </div>
            <div class="preview-list" id="previewList"></div>
        </div>

        <div class="card">
            <h2>üìà Â≠¶‰π†ÁªüËÆ°</h2>

            <div style="font-size:12px; font-weight:bold; color:#64748b; margin-bottom:5px;">ÊâìÂç°ËÆ∞ÂΩï (2026 Activity)</div>

            <div class="heatmap-container">
                <div class="heatmap-months" id="heatmapMonths">
                    <!-- Months generated by JS -->
                </div>
                <div class="heatmap-body">
                    <div class="heatmap-days">
                        <div class="day-label" style="visibility:hidden">Sun</div>
                        <div class="day-label">Mon</div>
                        <div class="day-label" style="visibility:hidden">Tue</div>
                        <div class="day-label">Wed</div>
                        <div class="day-label" style="visibility:hidden">Thu</div>
                        <div class="day-label">Fri</div>
                        <div class="day-label" style="visibility:hidden">Sat</div>
                    </div>
                    <div id="heatmapGrid" class="heatmap-grid">
                        <!-- Squares generated by JS -->
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <div style="font-size:12px; font-weight:bold; color:#64748b; margin-bottom:5px;">Ê≠£Á°ÆÁéáË∂ãÂäø (Accuracy
                        Trend)</div>
                    <div id="accChart" class="chart-container">
                        <!-- Bars injected here -->
                    </div>
                </div>
                <div style="flex:1;">
                    <div style="font-size:12px; font-weight:bold; color:#64748b; margin-bottom:5px;">ËøëÊúüÁªÉ‰π†ËÆ∞ÂΩï (Recent
                        Exams)</div>
                    <div id="examList"
                        style="height:200px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px; padding:10px;">

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFilename = "";
        let extractedData = [];
        let availableQuestions = []; // [{num, type}]
        let selectedIds = new Set();

        // Theme Config
        const THEMES = {
            "theme1": {
                upload: "/static/assets/running.png",
                preview: "/static/assets/archery.png",
                import: "/static/assets/weightlifting.png",
                generate: "/static/assets/fire-torch.png"
            },
            "theme2": {
                upload: "/static/assets/javelin-throw.png",
                preview: "/static/assets/archery.png",
                import: "/static/assets/weightlifting.png",
                generate: "/static/assets/pyre.png"
            }
        };

        function switchTheme(themeName) {
            const t = THEMES[themeName];
            if (!t) return;

            document.getElementById('icon_upload').src = t.upload;
            document.getElementById('icon_preview').src = t.preview;
            document.getElementById('icon_import').src = t.import;
            document.getElementById('icon_generate_header').src = t.generate;
            document.getElementById('icon_generate_btn').src = t.generate;

            // Persist
            localStorage.setItem('mistake_theme', themeName);
        }

        function toggleTheme() {
            let current = localStorage.getItem('mistake_theme') || 'theme1';
            let next = (current === 'theme1') ? 'theme2' : 'theme1';

            // Animate
            let btn = document.getElementById('themeToggleBtn');
            btn.style.transform = "rotate(360deg)";
            setTimeout(() => {
                btn.style.transform = "none";
            }, 500);

            switchTheme(next);
        }

        // Init logic
        let savedTheme = localStorage.getItem('mistake_theme') || 'theme1';
        switchTheme(savedTheme);

        // --- Upload & Analyze ---

        document.getElementById('fileInput').addEventListener('change', async function (e) {
            let file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').innerText = "Uploading: " + file.name;

            let formData = new FormData();
            formData.append("file", file);

            try {
                // 1. Upload
                let res = await fetch('/upload', { method: 'POST', body: formData });
                let data = await res.json();
                currentFilename = data.filename;
                document.getElementById('fileName').innerText = "‚úÖ Â∑≤‰∏ä‰º†: " + currentFilename;

                // 2. Analyze Structure automatically
                analyzeFile(currentFilename);

            } catch (err) {
                alert("‰∏ä‰º†Â§±Ë¥•");
                console.error(err);
            }
        });

        async function analyzeFile(filename) {
            document.getElementById('gridPanel').style.display = 'block';
            document.getElementById('qGrid').innerHTML = '<div style="padding:20px; text-align:center;">Ê≠£Âú®ÂàÜÊûêËØïÂç∑ÁªìÊûÑ...</div>';

            try {
                let res = await fetch('/analyze_file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });

                if (!res.ok) throw new Error("Analyze failed");

                let data = await res.json();
                availableQuestions = data.questions; // List of {num, type}

                // Sort by num just in case
                availableQuestions.sort((a, b) => a.num - b.num);

                renderGrid();

                selectedIds.clear();
                updateSelectionUI();

            } catch (e) {
                document.getElementById('qGrid').innerHTML = '<div style="color:red; text-align:center;">ÂàÜÊûêÂ§±Ë¥•: ' + e.message + '</div>';
            }
        }

        // --- Grid Logic ---

        function renderGrid() {
            let html = "";
            availableQuestions.forEach(q => {
                let isSel = selectedIds.has(q.num);
                let typeClass = getTypeClass(q.type);
                html += `<div class="grid-item ${isSel ? 'selected' : ''} ${typeClass}" 
                              onclick="toggleSelection(${q.num}, this)">
                             ${q.num}
                             <span class="type-tag">${q.type || 'Êú™Áü•'}</span>
                         </div>`;
            });
            document.getElementById('qGrid').innerHTML = html;
        }

        function getTypeClass(type) {
            if (!type) return "";
            if (type.includes("Â∏∏ËØÜ")) return "t-changshi";
            if (type.includes("Ë®ÄËØ≠")) return "t-yanyu";
            if (type.includes("Êï∞Èáè")) return "t-shuliang";
            if (type.includes("ËµÑÊñô")) return "t-ziliao";
            if (type.includes("Âà§Êñ≠") || type.includes("ÈÄªËæë") || type.includes("ÂõæÂΩ¢") || type.includes("ÂÆö‰πâ") || type.includes("Á±ªÊØî")) return "t-panduan";
            return "";
        }

        function toggleSelection(num, el) {
            if (selectedIds.has(num)) {
                selectedIds.delete(num);
                el.classList.remove('selected');
            } else {
                selectedIds.add(num);
                el.classList.add('selected');
            }
            updateSelectionUI();
        }

        function selectAll() {
            availableQuestions.forEach(q => selectedIds.add(q.num));
            renderGrid(); // Re-render to update classes
            updateSelectionUI();
        }

        function clearSelection() {
            selectedIds.clear();
            renderGrid();
            updateSelectionUI();
        }

        function updateSelectionUI() {
            document.getElementById('selectionSummary').innerText = `Â∑≤ÈÄâ: ${selectedIds.size} È¢ò`;
        }

        async function extractPreview() {
            if (!currentFilename) return alert("ËØ∑ÂÖà‰∏ä‰º†Êñá‰ª∂");
            if (selectedIds.size === 0) return alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÈÅìÈ¢ò");

            document.getElementById('extractBtn').innerText = "Processing...";

            // Convert Set to Array
            let ids = Array.from(selectedIds).sort((a, b) => a - b);

            try {
                let res = await fetch('/extract_preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: currentFilename, ids: ids })
                });

                if (!res.ok) {
                    let errData = await res.json();
                    throw new Error(errData.detail || "Server Error " + res.status);
                }

                let data = await res.json();
                extractedData = data.questions;
                renderPreview(data.questions);
                document.getElementById('previewArea').style.display = 'block';

                // Scroll to preview
                document.getElementById('previewArea').scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                alert("Ëß£ÊûêÂ§±Ë¥•: " + err);
            } finally {
                document.getElementById('extractBtn').innerText = "üîç Ëß£ÊûêÈ¢ÑËßà";
            }
        }

        // --- Existing Utils ---

        const SCORE_MAP = {
            'Ë®ÄËØ≠': 0.8,
            'Êï∞Èáè': 0.8,
            'ËµÑÊñô': 1.0,
            'Â∏∏ËØÜ': 0.5,
            'ÂõæÂΩ¢': 0.6,
            'ÂÆö‰πâ': 0.7,
            'Á±ªÊØî': 0.5,
            'ÈÄªËæë': 0.8,
            'Âà§Êñ≠': 0.7
        };

        function renderPreview(list) {
            let html = "";
            let totalLostScore = 0;

            list.forEach(q => {
                let score = SCORE_MAP[q.type] || 0.5;
                if (!q.type) score = 0.5; // fallback
                totalLostScore += score;

                html += `
                <div class="q-item">
                    <div class="q-meta">
                        #${q.original_num}<br>
                        <span style="font-size:12px; color:#64748b">${q.type || 'Êú™Áü•'}</span><br>
                        <span style="font-size:12px; color:#ef4444">-${score}ÂàÜ</span>
                        ${q.material_content ? '<br><span class="material-badge">Âê´ÊùêÊñô</span>' : ''}
                    </div>
                    <div class="q-content">
                        ${q.content_html}
                        <div style="margin-top:5px; color:#64748b; font-size:0.9em;">
                            <strong>Options:</strong><br>
                            ${q.options_html || '(Êó†ÂçïÁã¨ÈÄâÈ°π)'}
                        </div>
                    </div>
                </div>
            `;
            });
            document.getElementById('previewList').innerHTML = html;
            document.getElementById('previewCount').innerText = list.length + ` (‰∏¢ÂàÜ: ${totalLostScore.toFixed(1)})`;
        }

        async function confirmSave() {
            if (extractedData.length === 0) return;
            if (!confirm("Á°ÆËÆ§Â∞ÜËøô " + extractedData.length + " ÈÅìÈ¢òÂä†ÂÖ•ÈîôÈ¢òÊ±†?")) return;

            try {
                let res = await fetch('/confirm_save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_filename: currentFilename,
                        questions: extractedData,
                        all_questions_meta: availableQuestions
                    })
                });
                let data = await res.json();
                alert("ÊàêÂäüÂÖ•Â∫ì " + data.saved_count + " È¢ò! ÁªüËÆ°Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞„ÄÇ");
                location.reload();
            } catch (err) {
                alert("‰øùÂ≠òÂ§±Ë¥•");
            }
        }

        async function generatePaper() {
            let count = document.getElementById('genCount').value;
            try {
                document.getElementById('downloadArea').innerHTML = "Generating...";
                let res = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ total_count: parseInt(count) })
                });

                if (!res.ok) {
                    let err = await res.json();
                    throw new Error(err.detail);
                }

                let data = await res.json();

                if (data.download_url) {
                    // Create trigger
                    let link = document.createElement('a');
                    link.href = data.download_url;
                    link.download = '';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    document.getElementById('downloadArea').innerHTML = `‚úÖ Â∑≤‰∏ãËΩΩ (${data.count} È¢ò)`;
                } else {
                    throw new Error("No download URL returned");
                }

            } catch (e) {
                document.getElementById('downloadArea').innerHTML = "‚ùå Error: " + e.message;
            }
        }

        async function loadStats() {
            try {
                let res = await fetch('/pool_status');
                let data = await res.json();
                let html = "";
                for (let type in data) {
                    html += `
                    <a href="/browse?q=${encodeURIComponent(type)}" class="stat-box" title="ÁÇπÂáªÊü•Áúã ${type} Á±ªÈ¢òÁõÆ" style="text-decoration:none; color:inherit; display:block; transition:transform 0.1s; cursor:pointer;">
                        <div class="stat-num">${data[type]}</div>
                        <div>${type}</div>
                    </a>
                `;
                }
                if (!html) html = "<div class='stat-box'>ÈîôÈ¢òÊ±†‰∏∫Á©∫</div>";
                document.getElementById('stats-bar').innerHTML = html;
            } catch (e) { console.log(e); }
        }

        async function loadExamStats() {
            try {
                let res = await fetch('/api/exam_stats');
                let data = await res.json();
                renderExamStats(data.stats);
            } catch (e) {
                console.error("Failed to load exam stats", e);
            }
        }

        function renderExamStats(stats) {
            // 1. Prepare Data
            let dateMap = {};
            stats.forEach(s => {
                let d = s.upload_date.split('T')[0];
                if (!dateMap[d]) dateMap[d] = 0;
                dateMap[d] += 1; // Count exams
            });

            // 2. Heatmap: 2026 Grid
            const grid = document.getElementById('heatmapGrid');
            const monthsHeader = document.getElementById('heatmapMonths');
            grid.innerHTML = "";
            monthsHeader.innerHTML = "";

            // 2026 starts on Thursday (index 4 if Sun=0, or 3 if Mon=0?)
            // JS getDay(): 0=Sun, 1=Mon, ..., 4=Thu.
            // Requirement aligns with User screenshot: Mon, Wed, Fri rows.
            // This is GitHub style (Sunday start) but rows are usually 0-6.
            // If rows are 0-6, and Sun is 0. 
            // Jan 1 2026 is Thursday.

            const year = 2026;
            const startStr = "2026-01-01";
            const endStr = "2026-12-31";
            const totalDays = 365; // 2026 is not a leap year

            let current = new Date(year, 0, 1); // Jan 1

            // We need to shift to Sunday (or Mon) to align the grid. 
            // GitHub starts week on Sunday. 
            // Let's assume SUNDAY START for columns.
            // Day 0 = Sunday.

            // Calculate padding: how many days before Jan 1 until previous Sunday
            let startDay = current.getDay(); // 4 (Thu)
            // Empty cells before Jan 1
            for (let i = 0; i < startDay; i++) {
                let d = document.createElement("div");
                d.className = "day-square";
                d.style.visibility = "hidden"; // Invisible padding
                grid.appendChild(d);
            }

            // Loop all days
            let months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let addedMonths = new Set();

            // We want to place Month labels approx over the first week they appear.
            // Since we are using grid-auto-flow: column, and grid rows=7.
            // A column is a week.
            // We can approximate month positions.

            // Let's manually build weeks to correctly place month headers?
            // Actually, simpler:
            // CSS Grid simply flows items.
            // JS just dumps 365 items (plus start padding).
            // But headers need to line up with columns.
            // So we need to know which COLUMN index a month starts in.

            let daysSoFar = startDay; // because of padding

            while (current.getFullYear() === year) {
                let dStr = current.toISOString().split('T')[0];
                let count = dateMap[dStr] || 0;

                // Color level
                let level = 0;
                if (count > 0) level = 1;
                if (count > 2) level = 2;
                if (count > 5) level = 3;
                if (count > 10) level = 4;

                let div = document.createElement("div");
                div.className = `day-square level-${level}`;
                div.setAttribute('data-title', `${dStr}: ${count} Exams`);
                grid.appendChild(div);

                // Month Logic
                // If it's the 1st of month (or close if 1st is late in week), add label
                // Actually GitHub puts label if the week contains the 1st?
                // Or simply: check if current date is 1st.
                if (current.getDate() <= 7) {
                    // This is a rough check.
                    // Correct way: identify the column index.
                    // col_index = Math.floor(daysSoFar / 7);
                    // But we only want one label per month.
                    let mIndex = current.getMonth();
                    if (!addedMonths.has(mIndex)) {
                        // Check implies we verify if this is the first week of the month
                        // To be precise:
                        // We can simple append month labels with margin-left proportional to weeks.
                        // But that's hard with flex.
                    }
                }

                current.setDate(current.getDate() + 1);
                daysSoFar++;
            }

            // Simple Month Labels (Approximate)
            // Just use fixed spacing or flex basis? 
            // 52 weeks. 12 months.
            // Jan is at 0. Feb at approx 4.5 weeks.
            // Let's try to be smarter.
            // We know the day-of-year for start of each month.
            // Jan 1 = Day 0
            // Feb 1 = Day 31
            // Mar 1 = Day 59 ...

            // Each column is 7 days.
            // Col width ~= 13px (10+3).
            // Width = (DayOfYear + StartPadding) / 7 * 13px

            const monthDays = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
            let monthHtml = "";
            monthDays.forEach((d, i) => {
                let offsetDays = d + startDay;
                let colIndex = Math.floor(offsetDays / 7);
                let px = colIndex * 13;
                // We can use absolute positioning or relative margins?
                // Absolute in container is easiest.
                // or just one div with multiple spans and precise left margins.
            });

            // Let's use a simpler approach for months: 
            // Just flex-grow spacers? No.
            // Absolute position relative to heatmap-months container.
            document.getElementById('heatmapMonths').style.position = 'relative';
            document.getElementById('heatmapMonths').style.height = '15px';

            monthDays.forEach((d, i) => {
                let colIndex = Math.floor((d + startDay) / 7);
                let leftPos = colIndex * 13;
                let mSpan = document.createElement('span');
                mSpan.innerText = months[i];
                mSpan.style.position = 'absolute';
                mSpan.style.left = leftPos + 'px';
                monthsHeader.appendChild(mSpan);
            });


            // 3. Trend Chart (Accuracy) - SAME AS BEFORE
            let chart = document.getElementById('accChart');
            chart.innerHTML = "";
            // Take last 20 records
            let recent = stats.slice(-20);
            recent.forEach(s => {
                let h = s.total_accuracy; // 0-100
                let bar = document.createElement("div");
                bar.className = "bar-chart-bar";
                bar.style.height = `${h}%`;
                bar.innerHTML = `<div class="bar-tooltip">${s.upload_date.split('T')[0]}<br>Acc: ${h.toFixed(1)}%<br>Score: ${s.total_score.toFixed(1)}</div>`;
                chart.appendChild(bar);
            });

            // 4. List
            let list = document.getElementById('examList');
            let listHtml = "";
            let reversed = [...stats].reverse();
            reversed.slice(0, 50).forEach(s => {
                listHtml += `
                    <div style="padding:8px; border-bottom:1px solid #f1f5f9; font-size:12px;">
                        <div style="font-weight:bold; color:#334155;">${s.filename}</div>
                        <div style="display:flex; justify-content:space-between; margin-top:2px;">
                            <span style="color:#64748b">${s.upload_date.split('T')[0]}</span>
                            <span style="color:${getScoreColor(s.total_accuracy)}">${s.total_accuracy.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            });

            if (stats.length === 0) {
                listHtml = "<div style='color:#999; text-align:center; padding:20px;'>No records yet. Upload a mistake paper to start tracking!</div>";
            }

            list.innerHTML = listHtml;
        }

        function getScoreColor(acc) {
            if (acc >= 90) return '#16a34a';
            if (acc >= 75) return '#d97706';
            return '#ef4444';
        }

        loadStats();
        loadExamStats();
    </script>
    <script>
        // Heartbeat to keep server alive
        setInterval(() => {
            fetch('/api/heartbeat', { method: 'POST' }).catch(() => { });
        }, 1000);
    </script>
</body>

</html>